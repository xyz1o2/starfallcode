# ğŸš€ æµå¼å¤„ç†å¿«é€Ÿå¼€å§‹

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI äº‹ä»¶å¾ªç¯ (tokio::select!)            â”‚
â”‚ - é”®ç›˜äº‹ä»¶                              â”‚
â”‚ - æµæ›´æ–° (mpsc é€šé“)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åå°å¼‚æ­¥ä»»åŠ¡ (tokio::spawn)             â”‚
â”‚ - Agent æµå¼å¤„ç†                        â”‚
â”‚ - é€šé“å‘é€                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP å®¢æˆ·ç«¯ (reqwest)                   â”‚
â”‚ - è¶…æ—¶é…ç½®                              â”‚
â”‚ - è‡ªåŠ¨é‡è¯•                              â”‚
â”‚ - SSE è§£æ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
  â†“
ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  â†“
åˆ›å»ºç©º Assistant æ¶ˆæ¯
  â†“
spawn åå°ä»»åŠ¡
  â†“
æµå¼æ¥æ”¶ AI å“åº”
  â†“
é€šè¿‡ mpsc å‘é€åˆ° UI
  â†“
tokio::select! æ¥æ”¶
  â†“
å®æ—¶æ›´æ–° UI
```

---

## ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨åº”ç”¨

```bash
cd grok-cli
cargo run
```

### å‘é€æ¶ˆæ¯

1. è¾“å…¥æ¶ˆæ¯
2. æŒ‰ Enter
3. è§‚å¯Ÿå®æ—¶æµå¼å“åº”

### ç‰¹æ€§

- âœ… ç”¨æˆ·æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
- âœ… AI å“åº”é€å—æ˜¾ç¤º
- âœ… å¯åœ¨å“åº”æ—¶ç»§ç»­è¾“å…¥
- âœ… è‡ªåŠ¨é”™è¯¯é‡è¯•

---

## ä»£ç ç‰‡æ®µ

### åˆ›å»ºé€šé“

```rust
use tokio::sync::mpsc;

#[derive(Clone, Debug)]
enum StreamMessage {
    Content(String),
    Done,
    Error(String),
}

let (tx, mut rx) = mpsc::channel::<StreamMessage>(100);
```

### äº‹ä»¶å¾ªç¯

```rust
tokio::select! {
    // é”®ç›˜äº‹ä»¶
    event_result = async {
        if event::poll(std::time::Duration::from_millis(250))? {
            event::read()
        } else {
            Err(std::io::Error::new(std::io::ErrorKind::WouldBlock, "timeout"))
        }
    } => {
        // å¤„ç†é”®ç›˜
    }
    
    // æµæ›´æ–°
    Some(update) = rx.recv() => {
        match update {
            StreamMessage::Content(content) => {
                // è¿½åŠ å†…å®¹
            }
            StreamMessage::Done => {
                // å®Œæˆ
            }
            StreamMessage::Error(e) => {
                // é”™è¯¯
            }
        }
    }
}
```

### åå°ä»»åŠ¡

```rust
let task = tokio::spawn(async move {
    match agent_clone.process_user_message_stream(&msg).await {
        Ok(mut stream) => {
            while let Some(chunk) = stream.next().await {
                match chunk {
                    Ok(chunk) => {
                        let _ = tx_clone.send(StreamMessage::Content(content)).await;
                    }
                    Err(e) => {
                        let _ = tx_clone.send(StreamMessage::Error(e)).await;
                    }
                }
            }
        }
        Err(e) => {
            let _ = tx_clone.send(StreamMessage::Error(e.to_string())).await;
        }
    }
});
```

---

## é…ç½®å‚æ•°

### HTTP è¶…æ—¶

```rust
// src/grok/client.rs
let http_client = reqwest::Client::builder()
    .timeout(std::time::Duration::from_secs(120))      // è¯·æ±‚è¶…æ—¶
    .connect_timeout(std::time::Duration::from_secs(30)) // è¿æ¥è¶…æ—¶
    .build()?;
```

### é‡è¯•é…ç½®

```rust
// è‡ªåŠ¨é‡è¯• 3 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿
let max_retries = 3;
let wait_time = std::time::Duration::from_secs(2_u64.pow(retries as u32));
```

### äº‹ä»¶è½®è¯¢

```rust
// UI äº‹ä»¶è½®è¯¢è¶…æ—¶
event::poll(std::time::Duration::from_millis(250))?
```

### é€šé“ç¼“å†²

```rust
// é€šé“ç¼“å†²å¤§å°
let (tx, rx) = mpsc::channel::<StreamMessage>(100);
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä½¿ç”¨ tokio::select!ï¼Ÿ
A: å…è®¸å¹¶å‘å¤„ç†é”®ç›˜äº‹ä»¶å’Œæµæ›´æ–°ï¼Œä¸é˜»å¡ UIã€‚

### Q: é€šé“ç¼“å†²å¤§å°ä¸ºä»€ä¹ˆæ˜¯ 100ï¼Ÿ
A: å¹³è¡¡å†…å­˜å ç”¨å’Œååé‡ã€‚å¯æ ¹æ®éœ€è¦è°ƒæ•´ã€‚

### Q: å¦‚ä½•å¤„ç†æµä¸­æ–­ï¼Ÿ
A: é€šè¿‡ `StreamMessage::Error` æ•è·é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•ã€‚

### Q: è¶…æ—¶æ—¶é—´å¯ä»¥æ”¹å—ï¼Ÿ
A: å¯ä»¥ï¼Œä¿®æ”¹ `client.rs` ä¸­çš„ Duration å€¼ã€‚

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¢åŠ é€šé“ç¼“å†²**
   - å¦‚æœæµæ›´æ–°é¢‘ç¹ï¼Œå¢åŠ ç¼“å†²å¤§å°
   - æƒè¡¡å†…å­˜ vs ååé‡

2. **è°ƒæ•´äº‹ä»¶è½®è¯¢**
   - å‡å°‘å»¶è¿Ÿï¼šé™ä½ 250ms
   - é™ä½ CPUï¼šå¢åŠ  250ms

3. **ä¼˜åŒ–é‡è¯•ç­–ç•¥**
   - å¢åŠ é‡è¯•æ¬¡æ•°å¤„ç†ä¸ç¨³å®šç½‘ç»œ
   - å‡å°‘é‡è¯•æ¬¡æ•°åŠ å¿«å¤±è´¥

4. **æµå¼ç¼“å­˜**
   - ä¿å­˜å“åº”ä»¥æ”¯æŒç¦»çº¿æŸ¥çœ‹
   - å®ç°æ¶ˆæ¯æŒä¹…åŒ–

---

## è°ƒè¯•æŠ€å·§

### å¯ç”¨æ—¥å¿—

```rust
// åœ¨ main.rs ä¸­
env_logger::init();
```

### ç›‘æ§æµæ›´æ–°

```rust
eprintln!("ğŸ“¨ Received: {:?}", update);
```

### æ£€æŸ¥é€šé“çŠ¶æ€

```rust
eprintln!("ğŸ“Š Channel: tx={}, rx={}", tx.capacity(), rx.len());
```

---

## æ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `src/grok/client.rs` | HTTP å®¢æˆ·ç«¯ + è¶…æ—¶ + é‡è¯• |
| `src/ui/mod.rs` | UI äº‹ä»¶å¾ªç¯ + é€šé“å¤„ç† |
| `src/agent/mod.rs` | Agent æµå¼ API |
| `src/types/mod.rs` | ç±»å‹å®šä¹‰ |

---

## ä¸‹ä¸€æ­¥

1. è¿è¡Œåº”ç”¨æµ‹è¯•æµå¼å¤„ç†
2. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
3. æ ¹æ®éœ€è¦è°ƒæ•´å‚æ•°
4. æ·»åŠ æ—¥å¿—å’ŒæŒ‡æ ‡æ”¶é›†

---

**å¿«é€Ÿå¼€å§‹å®Œæˆï¼** ğŸ‰
